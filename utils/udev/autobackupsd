#!/bin/bash

# Settings
DEFAULT_MOUNT_POINT='/media/autobackupsd'
LOG_FOLDER='/var/log/autobackupsd'
HOME_LOG_FOLDER='~/.autobackupsd'
BACKUP_COMMAND='/usr/local/bin/arcpics'

# Cancel any pending shutdown
shutdown -c

led() {
  if [ -w /proc/acpi/nuc_led ]
  then
    echo "ring,$1,$2,$3" |  tee /proc/acpi/nuc_led > /dev/null
  fi
}

error () {
  if [ "$1" ]
  then
    printf "\033[91m$1\033[0m\n"
    notification "$1"
  fi
  led "90" "blink_fast" "red"  
}

check_exit_code() {
  if [ "$?" != "0" ]
  then     
     error "Error $1"
     exit $?
  fi
}

info() {
  echo $1
  notification "$1"
}

notification() {
  if [ -z "$TELEGRAM_BOT_KEY" ]
  then
      echo "No TELEGRAM_BOT_KEY"
      return 1
  fi

  if [ -z "$TELEGRAM_CHAT_ID" ]
  then
      echo "No TELEGRAM_CHAT_ID"
      return 1
  fi
  
  MESSAGE=$(printf "$1")
  echo "MESSAGE: $MESSAGE"
  curl -m 5 "https://api.telegram.org/bot$TELEGRAM_BOT_KEY/sendMessage?parse_mode=Markdown&chat_id=$TELEGRAM_CHAT_ID" --data-urlencode "text=*SD Backup:* $MESSAGE" > /dev/null 2>&1
}

[ -d "$LOG_FOLDER" ] || mkdir "$LOG_FOLDER"
if  [ ! -w "$LOG_FOLDER" ]
then
  LOG_FOLDER = "$HOME_LOG_FOLDER"
  [ -d "$LOG_FOLDER" ] || mkdir "$LOG_FOLDER"
fi

if [[ ! $- == *i* ]]
then  
  if [ -w "$LOG_FOLDER" ]
  then
    LOG_FILE="$LOG_FOLDER/$(date +%F-%T).log"
    echo "Using log file '$LOG_FILE'"
    exec >> $LOG_FILE
    exec 2>&1
  fi
fi

if [ -f /etc/autobackupsd ]
then
  echo "Reading config: /etc/autobackupsd"
  source /etc/autobackupsd
fi

# Must be 1
if [ "$ID_DRIVE_FLASH_SD" != "1" ]
then
  echo "Device is not a SD Card: $DEVNAME ."
  exit 1 # Exit silently.
fi

# Must be a block device
if [ ! -b "$DEVNAME" ]
then  
  error "Device '$DEVICENAME' is not a block device"
  exit 1
fi

# Must be partition
if [ "$DEVTYPE" != "partition" ]
then
  error "Device is not a partition: $DEVTYPE."
  exit 1
fi


MOUNT_POINT=$(lsblk -o MOUNTPOINT -nr "$DEVNAME" | xargs)

ALREADY_MOUNTED=true
if [ -z "$MOUNT_POINT" ]
then
  echo "$DEVNAME not yet mounted. Mounting..."
  # Create dir if not exists
  MOUNT_POINT="$DEFAULT_MOUNT_POINT"
  if [ ! -d "$MOUNT_POINT" ]
  then
    mkdir "$MOUNT_POINT"
  fi
  # Mount device
  mount "$DEVNAME" "$MOUNT_POINT"
  check_exit_code "Mounting $DEVNAME"
  ALREADY_MOUNTED=false
else 
  echo "$DEVNAME mounted in $MOUNT_POINT"
fi

if [ ! -d "$MOUNT_POINT/DCIM" ]
then
  echo "SD Card does not contains a picture folder: $MOUNT_POINT/DCIM"  
  exit 1
fi

if [ -w "$LOG_FOLDER" ]
then
  LOG_RESULTS_FILE="$LOG_FOLDER/$(date +%F-%T).result"
fi

info "Starting backup from $MOUNT_POINT/DCIM"

led "70" "fade_medium" "green"

$BACKUP_COMMAND -l "$LOG_RESULTS_FILE" "$MOUNT_POINT/DCIM"
check_exit_code "Backup script"

led "70" "fade_fast" "green"

if [ "$ALREADY_MOUNTED" == false ] 
then
  echo "Unmounting $DEVNAME"
  umount "$DEVNAME"
fi

if [ -f "$LOG_RESULTS_FILE" ]
then
  source "$LOG_RESULTS_FILE"
  notification "\n\n*Done!*\n\n $COPIED_NUMBER of $TOTAL_NUMBER ($DATA_AMOUNT) files copied to $DESTINATION_PATH in $DURATION_TIME.\n$FREE_SPACE_IN_DESTINATION_PATH available."
  echo "Done!"
else
  info "Done!"
fi
led "100" "none" "green"

